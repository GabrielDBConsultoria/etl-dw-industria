# ETL Documentation - DW (Unified Model)

✨ **Objective**  
This ETL process extracts data from the ERP (OLTP base) and loads it in a structured manner into a MySQL Data Warehouse called **dw_xodo**. The main change in this project is the unification of the fact tables into a single table, **fato_vendasitens**, which consolidates the header (order) and item data for subsequent analyses, thereby adopting a Star Schema model for our data warehouse.

---

📂 **Overall Structure**

**Dimensions** (completely refreshed on each execution):  
- **dim_filial**  
- **dim_atividade**  
- **dim_pessoa**  
- **dim_colaborador**  
- **dim_motdevolucao**  
- **dim_produto** (includes the field **pro_ativo**, where 1 = active and 0 = inactive)

**Fact** (incremental update):  
- **fato_vendasitens** – unified table that consolidates order and item data.

---

⚙️ **Dimension Logic**  
All dimensions are refreshed via a complete DELETE before inserting new data.  
This ensures synchronization between the DW and the ERP without the need for complex incremental controls.

**Highlights:**  
- **dim_motdevolucao** includes an extra fallback reason with code 999999 – "SEM MOTIVO" ("NO REASON").  
- **dim_produto** loads only products with `pro_grpcodigo = 1` or specific product codes (e.g., 1801, 704, 1723) and includes the field **pro_ativo**.

---

📊 **Fact: fato_vendasitens (Unified Model)**

**Primary Key:**  
- **Id_ItemPedido** – Generated by concatenating the following fields from the *itenspedido* table:  
  - **ipv_filcodigo** (format: 2 digits)  
  - **ipv_spvcodigo** (format: 3 digits)  
  - **ipv_pednumero** (format: 10 digits)  
  - **ipv_procodigo** (format: 11 digits)  
  *Example:*  
  `LPAD(ipv_filcodigo, 2, '0') & LPAD(ipv_spvcodigo, 3, '0') & LPAD(ipv_pednumero, 10, '0') & LPAD(ipv_procodigo, 11, '0')`

**Other Important Fields:**

*From the Header (Order):*  
- **ped_filcodigo** – Branch code.  
- **ped_pescodigo** – Customer code.  
- **ped_vencodigo** – Sales representative code.  
- **ped_natcodigo** – acronym for the type of business operation.  
- **ped_numero** – Order number.  
- **ped_dtemissao** – Order issue date.  
- **ped_dtEntrega** – Delivery date.

*From the Item:*  
- **ipv_ProCodigo** – Product code.  
- **ipv_mtdcodigo** – Return reason code (if the item is returned); if absent, defaults to 999999.  
- **ipv_Quantidade** – Quantity of the item.  
- **ipv_propbruto** – Gross weight (kg) of the item.  
- **ipv_precovenda** – Selling price.  
- **ipv_valsubst** – Substitute value (if applicable).

**Join with Movdevolucao:**  
The fact load includes a LEFT JOIN with the **movdevolucao** table to capture the return reason.  
The concatenation logic used to generate the join identifier in **movdevolucao** is the same as that used for **Id_ItemPedido**, using the following fields:
- **mvd_filcodigo** (2 digits),  
- **mvd_spvcodigo** (3 digits),  
- **mvd_numero** (10 digits),  
- **mvd_procodigo** (11 digits).  

Additionally, we assume that `ipv_numitem = mvd_numitem` to ensure an exact match between the registered item and the return reason.

**Incremental Update:**  
The fact load process in **fato_vendasitens** is incremental, where for each new identified record, a DELETE (if it exists) is performed followed by an INSERT, thereby ensuring data consistency.

**Filters Applied During Load:**  
- **Issue Date:** `YEAR(Ped_DtEmissao) >= 2025`  
- **Order Status:** `Ped_StpCodigo = 6`  
- **Order Nature:** `Ped_NatCodigo IN ('VE', 'VTE', 'VIN', 'VTI', 'DEV', 'DTR', 'DV')`

---

✅ **Technical Considerations**  
- The ETL uses **pyodbc** and **pandas** to extract data in chunks (5000 records at a time), avoiding memory overload.  
- All insert commands follow a DELETE + INSERT pattern to maintain data integrity and consistency.  
- The ETL script is structured to run sequentially, beginning with dimension loads and then proceeding with the unified fact load.  
- Integrity checks are performed to ensure that the inserted records contain correct values and that joins (especially with the **movdevolucao** table) function as expected.

---

🔎 **Integrity Checks**  
After loading the fact data, it is recommended to validate data consistency; for example, by verifying that the return reason records are correct (counting how many times each **mtd_codigo** is used).

---

📖 **Suggestions for Expansion**  
- Create audit tables to log ETL execution details.  
- Automate the ETL execution with schedulers or tools such as Airflow.  
- Implement incremental update flags in the dimensions to optimize future loads.

---

This document summarizes the new ETL process, the changes implemented to unify the fact tables, and the key details for the maintenance and future expansion of the Data Warehouse.
