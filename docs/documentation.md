# ETL Documentation - DW Xodó

## ✨ Objective
This ETL process aims to extract data from the ERP (OLTP source) and load it in a structured format into a MySQL Data Warehouse called `dw_xodo`, properly separating dimension and fact tables for analytical purposes.

## 📂 General Structure

### Dimensions (fully updated on each execution):
- `dim_filial`
- `dim_atividade`
- `dim_pessoa`
- `dim_colaborador`
- `dim_motdevolucao`
- `dim_produto`

### Facts (incremental updates):
- `fato_pedidos`
- `fato_itenspedido`

## ⚙️ Dimension Logic
All dimensions are fully updated using `DELETE` before inserting new data. This ensures synchronization without the need for incremental control.

### Highlights:
- `dim_motdevolucao` includes an extra reason `999999 - SEM MOTIVO` (NO REASON), used as a fallback for unmatched records.
- `dim_produto` includes products where `pro_grpcodigo = 1` or with specific codes `1801`, `704`, `1723`.

## 📊 Fact Table: `fato_pedidos`
- **Key**: `Id_Pedido` generated by concatenating: `filcodigo` + `spvcodigo` + `numero`
- **Incremental Update**: Only new records are inserted.
- If `Id_Pedido` already exists, it is deleted before reinsertion.
- **Filters**:
  - `YEAR(ped_dtemissao) >= 2025`
  - `ped_stpcodigo = 6`
  - `ped_natcodigo IN ('VE','VTE','VIN','VTI','DEV','DTR','DV')`

## 📊 Fact Table: `fato_itenspedido`
- **Key**: `Id_ItemPedido` generated by: `Id_Pedido` + `ipv_numitem`
- **Join** with `movdevolucao` to fetch the `mtd_codigo`
- If there is no return reason, `999999` is assumed
- **Incremental update** using `DELETE` by `Id_ItemPedido`
- **Same filters** as `fato_pedidos`
- Columns `ipv_filcodigo` and `ipv_spvcodigo` were removed since they are already included in `Id_Pedido` and available in `fato_pedidos`

## ✅ Notes
- Uses `pyodbc` and `pandas` to read data in chunks (5000 records per iteration)
- All operations use `DELETE` + `INSERT` for consistency
- The full execution is done through sequential function calls

## 🔎 Integrity Checks
At the end of the `fato_itenspedido` load, a cross-check is performed to display which return reasons were used and how many times.

## 📖 Expansion Suggestions
- Create audit tables (ETL execution logs)
- Automate execution with a scheduler or Airflow
- Implement update flags in dimensions to optimize future loads

---

For official documentation, this Markdown format can be easily converted to PDF or HTML using tools like VSCode, Typora, Obsidian, or GitHub itself.
